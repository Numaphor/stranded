---
phase: 01-foundation-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/chunk_manager.cpp
  - src/validation/logging/distance_validation.cpp
  - src/validation/logging/distance_validation.h
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Chunks load within 4-chunk radius of player position efficiently"
    - "Chunks unload properly when outside 4-chunk radius to maintain memory efficiency"
    - "Player chunk position tracking remains accurate for boundary detection"
  artifacts:
    - path: "src/core/chunk_manager.cpp"
      provides: "Distance-based loading implementation"
      contains: "_determine_needed_chunks"
    - path: "src/validation/logging/distance_validation.cpp"
      provides: "Distance calculation validation and logging"
      exports: ["log_load_radius", "validate_distance_logic", "track_player_chunk"]
    - path: "src/validation/logging/distance_validation.h"
      provides: "Distance validation interface"
      contains: "CHUNK_LOAD_DISTANCE validation constants"
  key_links:
    - from: "src/core/chunk_manager.cpp"
      to: "src/validation/logging/distance_validation.cpp"
      via: "load/unload event logging"
      pattern: "log_load_radius.*chunk"
    - from: "src/validation/logging/distance_validation.cpp"
      to: "mGBA logging system"
      via: "Butano BN_LOG_LEVEL distance metrics"
      pattern: "BN_LOG_LEVEL.*DISTANCE"
---

<objective>
Validate and instrument distance-based chunk loading logic to ensure efficient 4-chunk radius operations.

Purpose: Confirm chunk loading operates within optimal radius while maintaining memory efficiency
Output: Validated distance-based loading with comprehensive tracking and performance metrics
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/core/chunk_manager.cpp
@include/str_chunk_manager.h
@include/str_constants.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Distance Calculation Validation</name>
  <files>src/validation/logging/distance_validation.h src/validation/logging/distance_validation.cpp</files>
  <action>
Create comprehensive distance-based loading validation:

1. Create src/validation/logging/distance_validation.h:
   - Define CHUNK_LOAD_DISTANCE (4 chunks) validation constants
   - Declare distance calculation validation functions
   - Include logging categories: DISTANCE_CALC, LOAD_RADIUS, PLAYER_TRACK
   
2. Create src/validation/logging/distance_validation.cpp:
   - Implement log_load_radius() to track chunk loading events within radius
   - Create validate_distance_logic() to verify 4-chunk radius calculations
   - Add track_player_chunk() to monitor player chunk position accuracy
   
   Use research pattern for distance logging:
   ```cpp
   BN_LOG_LEVEL(bn::log_level::INFO, "LOAD_RADIUS:", player_chunk_x, ",", player_chunk_y, 
                "-> chunk:", chunk_x, ",", chunk_y, "dist:", distance);
   ```

3. Implement edge case distance validation:
   - Test distance calculations at world boundaries (0,0) and (8191,8191)
   - Verify wrapping doesn't affect distance calculations
   - Validate Manhattan distance for chunk radius (not Euclidean)
</action>
  <verify>Distance calculations match expected 4-chunk radius for all test positions</verify>
  <done>Distance-based loading triggers correctly at 4-chunk boundary</done>
</task>

<task type="auto">
  <name>Task 2: Enhance Loading/Unloading Logic Verification</name>
  <files>src/core/chunk_manager.cpp</files>
  <action>
Enhance and validate the existing distance-based loading implementation:

1. Review current _determine_needed_chunks() implementation:
   - Verify CHUNK_LOAD_DISTANCE (4) constant usage matches requirements
   - Check that loading covers 9x9 visible area (player chunk + 4-chunk radius)
   - Ensure unloading logic properly handles chunks beyond 4-chunk radius

2. Add distance logic validation:
   - Validate that player chunk tracking (_player_chunk_x, _player_chunk_y) updates correctly
   - Check boundary detection for when player moves between chunks
   - Ensure chunk queueing respects distance calculations

3. Optimize loading efficiency:
   - Verify no redundant loading of already-loaded chunks
   - Check that unloading preserves necessary chunks within load radius
   - Validate that distance calculations use optimal integer arithmetic

Based on research - ensure chunk loading uses efficient distance checks without floating point.
</action>
  <verify>Load/unload operations trigger only at 4-chunk radius boundaries</verify>
  <done>Memory usage remains stable while maintaining 9x9 visible area</done>
</task>

<task type="auto">
  <name>Task 3: Create Load Radius Performance Testing</name>
  <files>src/validation/logging/distance_validation.cpp</files>
  <action>
Implement performance testing for distance-based loading:

1. Create load radius efficiency metrics:
   - Track loaded chunk count vs theoretical maximum (81 chunks for 9x9 area)
   - Monitor chunk turnover rate during continuous player movement
   - Measure distance calculation overhead per frame

2. Implement stress testing scenarios:
   - Rapid movement patterns to test loading/unloading responsiveness
   - Stationary player to verify minimal background activity
   - Diagonal movement to test corner case distance calculations

3. Add automated validation:
   - Verify exactly 81 chunks loaded at center of large world
   - Test boundary conditions when player at world edges
   - Validate chunk count remains within 128-slot vector limit

Use mGBA benchmarking approach from research to measure performance impact of distance calculations.
</action>
  <verify>Performance report shows efficient chunk loading within 4-chunk radius</verify>
  <done>Distance-based loading maintains optimal memory usage patterns</done>
</task>

</tasks>

<verification>
Run comprehensive distance validation tests:
- Stationary player: minimal loading activity
- Slow movement: gradual chunk turnover
- Rapid movement: responsive loading at radius boundaries
- Boundary testing: world edge distance calculations
- Performance testing: frame time impact measurements
</verification>

<success_criteria>
1. Chunks load efficiently within 4-chunk radius covering 9x9 visible area
2. Chunks unload properly when outside 4-chunk radius maintaining memory efficiency
3. Player chunk position tracking remains accurate for all movement patterns
4. Distance calculations use optimal integer arithmetic without floating point
5. Performance impact of distance-based loading is minimal (< 5% frame time)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-validation/01-02-SUMMARY.md`
</output>