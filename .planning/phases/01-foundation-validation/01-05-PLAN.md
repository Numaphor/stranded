---
phase: 01-foundation-validation
plan: 05
type: execute
wave: 2
depends_on: ["01-01", "01-02", "01-03", "01-04"]
files_modified:
  - src/core/world.cpp
  - src/validation/background/bg_validation.cpp
  - src/validation/background/bg_validation.h
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Background scrolling integrates smoothly with Butano affine background system"
    - "BGHOFS/BGVOFS register updates synchronize properly with chunk streaming"
    - "Rendering pipeline maintains compatibility with existing background layers"
  artifacts:
    - path: "src/core/world.cpp"
      provides: "Background integration with chunk streaming"
      contains: "background update and affine BG handling"
    - path: "src/validation/background/bg_validation.cpp"
      provides: "Comprehensive background system validation"
      exports: ["test_bg_register_sync", "validate_affine_compatibility", "check_rendering_pipeline"]
    - path: "src/validation/background/bg_validation.h"
      provides: "Background validation interface with Butano integration"
      contains: "Butano affine BG compatibility definitions"
  key_links:
    - from: "src/core/world.cpp"
      to: "src/validation/background/bg_validation.cpp"
      via: "background register synchronization validation"
      pattern: "test_bg_register_sync.*commit_to_vram"
    - from: "src/validation/background/bg_validation.cpp"
      to: "Butano background system"
      via: "affine_bg_ptr and bg_map_ptr interfaces"
      pattern: "affine_bg_ptr.*set_position"
---

<objective>
Validate and instrument background scrolling integration with Butano affine background system for seamless chunk streaming.

Purpose: Ensure chunk streaming works harmoniously with Butano's background management without conflicts
Output: Validated background integration maintaining smooth scrolling and rendering pipeline compatibility
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/core/world.cpp
@src/core/chunk_manager.cpp
@include/str_chunk_manager.h
@include/str_constants.h
@.planning/research/PHASE1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Background Validation Framework</name>
  <files>src/validation/background/bg_validation.h src/validation/background/bg_validation.cpp</files>
  <action>
Create comprehensive background system validation based on Butano integration patterns:

1. Create src/validation/background/bg_validation.h:
   - Define Butano affine background compatibility constants
   - Include validation functions for BG register synchronization
   - Declare background rendering pipeline validation interfaces
   
2. Create src/validation/background/bg_validation.cpp:
   - Implement test_bg_register_sync() for BGHOFS/BGVOFS validation
   - Add validate_affine_compatibility() for Butano affine_bg_ptr integration
   - Create check_rendering_pipeline() for layer compatibility testing
   
   Based on research Butano integration pattern:
   ```cpp
   void validate_affine_compatibility() {
       // Test bg_map_ptr with our buffer system
       bn::affine_bg_map_ptr bg_map = bg->map();
       
       BN_LOG_LEVEL(bn::log_level::INFO, "BG_COMPAT: map_cells:", bg_map.cells_count(),
                    " dimensions:", bg_map.width(), "x", bg_map.height());
       
       // Validate map dimensions match our 128x128 tile buffer
       BN_ASSERT(bg_map.width() == str::VIEW_BUFFER_TILES, "Map width mismatch");
       BN_ASSERT(bg_map.height() == str::VIEW_BUFFER_TILES, "Map height mismatch");
   }
   ```

3. Implement background timing validation:
   - Ensure background updates don't conflict with VBlank DMA operations
   - Test BG register synchronization with chunk streaming
   - Validate affine transform compatibility with buffer updates

Based on research pitfall #4: use Butano's bg_map_ptr and affine_bg_ptr interfaces, avoid direct register writes.
</action>
  <verify>Background validation framework detects all integration issues</verify>
  <done>Butano background system validation covers all critical integration points</done>
</task>

<task type="auto">
  <name>Task 2: Validate Background Scrolling Integration</name>
  <files>src/core/world.cpp</files>
  <action>
Review and enhance background scrolling integration with chunk streaming:

1. Analyze current background implementation in world.cpp:
   - Locate BGHOFS/BGVOFS register update calls
   - Check synchronization with chunk_manager::commit_to_vram()
   - Verify affine background transformation handling

2. Add background-scrolling validation:
   - Ensure background position updates match player movement
   - Validate that chunk streaming doesn't interfere with smooth scrolling
   - Test background register timing relative to VBlank DMA operations

   Review existing background update pattern:
   ```cpp
   // Current background update - verify synchronization
   void update_background() {
       // Update background offset registers
       bg->set_position(camera_x, camera_y);
       
       // Commit chunk changes to VRAM
       chunk_manager.commit_to_vram(bg->map());
   }
   ```

3. Implement Butano-affine compatibility checks:
   - Validate that affine transformations (rotation/scale) work with chunk updates
   - Test background layer priority with streaming background
   - Ensure no conflicts between chunk data and background tile data

Based on research: use Butano's affine_bg_ptr.set_position() instead of direct BGHOFS/BGVOFS writes.
</action>
  <verify>Background scrolling remains smooth during chunk streaming operations</verify>
  <done>Background updates synchronize properly with chunk VRAM updates</done>
</task>

<task type="auto">
  <name>Task 3: Test Rendering Pipeline Compatibility</name>
  <files>src/validation/background/bg_validation.cpp</files>
  <action>
Implement comprehensive rendering pipeline compatibility testing:

1. Create background layer integration testing:
   - Test chunk streaming with multiple background layers
   - Validate sprite system compatibility with streaming background
   - Ensure HUD elements render correctly over streaming chunks

2. Implement rendering order validation:
   ```cpp
   void check_rendering_pipeline() {
       // Verify rendering order: background -> entities -> sprites -> HUD
       BN_LOG_LEVEL(bn::log_level::INFO, "RENDER_PIPELINE: testing layer order");
       
       // Test that chunk streaming doesn't interfere with other layers
       // Validate background transparency and blending
       // Check sprite visibility over streaming chunks
   }
   ```

3. Add visual artifact detection:
   - Test for tearing or flickering during chunk updates
   - Validate smooth transitions during buffer origin changes
   - Check for visual conflicts between chunk data and background tiles

4. Performance impact validation:
   - Measure frame time impact of background integration
   - Test rendering pipeline under maximum chunk streaming load
   - Validate 60 FPS maintenance during all background operations

5. Stress testing scenarios:
   - Rapid camera movement with chunk streaming
   - Affine transformations (rotation/scale) during streaming
   - Background effects (transparency, blending) with chunk updates

Based on research: ensure all background register usage properly synchronized with chunk updates.
</action>
  <verify>Rendering pipeline maintains stability and performance during chunk streaming</verify>
  <done>All background system components work seamlessly with chunk streaming</done>
</task>

</tasks>

<verification>
Run comprehensive background integration tests:
- BG register synchronization: ensure proper timing with VBlank
- Butano compatibility: validate affine_bg_ptr and bg_map_ptr integration
- Rendering pipeline: test multi-layer rendering with streaming
- Visual validation: check for tearing, flickering, or artifacts
- Performance testing: measure frame impact of background integration
</verification>

<success_criteria>
1. Background scrolling integrates smoothly with Butano affine background system
2. BGHOFS/BGVOFS register updates synchronize properly with chunk streaming
3. Rendering pipeline maintains compatibility with existing background layers
4. Affine transformations (rotation/scale) work correctly with chunk streaming
5. Visual quality remains high with no artifacts during buffer operations
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-validation/01-05-SUMMARY.md`
</output>