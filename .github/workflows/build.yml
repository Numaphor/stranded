name: Build GBA ROM

on:
  push:
    branches: [main, 'devin/**']
  pull_request:
    branches: [main]

env:
  WONDERFUL_TOOLCHAIN: /opt/wonderful

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 python-is-python3

      - name: Set up Wonderful Toolchain Environment
        run: |
          echo "$WONDERFUL_TOOLCHAIN/bin" >> $GITHUB_PATH
          echo "$WONDERFUL_TOOLCHAIN/toolchain/gcc-arm-none-eabi/bin" >> $GITHUB_PATH
          echo "WONDERFUL_TOOLCHAIN=$WONDERFUL_TOOLCHAIN" >> $GITHUB_ENV
          
          # Verify the pre-installed toolchain from setup steps
          echo "Verifying pre-installed Wonderful Toolchain..."
          ls -la $WONDERFUL_TOOLCHAIN/ || echo "Toolchain directory not found"
          ls -la $WONDERFUL_TOOLCHAIN/bin/ || echo "Toolchain bin directory not found"
          ls -la $WONDERFUL_TOOLCHAIN/toolchain/gcc-arm-none-eabi/bin/ || echo "GBA toolchain not found"
      
      - name: Clean and Build ROM
        run: |
          export WONDERFUL_TOOLCHAIN=/opt/wonderful
          export PATH="$WONDERFUL_TOOLCHAIN/bin:$WONDERFUL_TOOLCHAIN/toolchain/gcc-arm-none-eabi/bin:$PATH"
          
          echo "Verifying build environment..."
          which arm-none-eabi-gcc || echo "arm-none-eabi-gcc not found"
          arm-none-eabi-gcc --version || echo "GCC version check failed"
          
          echo "Starting clean build..."
          make clean
          make -j$(nproc)
      
      - name: Verify ROM
        run: |
          if [[ -f "stranded.gba" ]]; then
            echo "✅ ROM build successful: stranded.gba created"
            ls -la stranded.gba
          else
            echo "❌ ROM build failed: stranded.gba not found"
            exit 1
          fi
      
      - name: Upload ROM Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: stranded-rom
          path: stranded.gba
          retention-days: 30
